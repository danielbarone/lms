version: 0.2

phases:
  pre_build:
    commands:
      - aws s3 cp s3://lma-terraform-config-files/microservices_demo.key terraform/microservices_demo.key
      - aws s3 cp s3://lma-terraform-config-files/microservices_demo.pem terraform/microservices_demo.pem
      - aws s3 cp s3://lma-terraform-config-files/terraform.tfvars terraform/terraform.tfvars
      - aws s3 cp s3://lms-api-gateway-config-files/.deploy.env api-gateway/.deploy.env
      - aws s3 cp s3://lms-api-gateway-config-files/.production.env api-gateway/.production.env
  build:
    commands:
      - sudo yum install -y yum-utils
      - sudo yum-config-manager --add-repo https://rpm.releases.hashicorp.com/AmazonLinux/hashicorp.repo
      - sudo yum -y install terraform
      - cd terraform
      - terraform init
      - terraform apply
      - cd ../node-deploy && npm i
      - npm run link
      - cd ../api-gateway && npm i
      - npm run linkall
      - npm run deploy
